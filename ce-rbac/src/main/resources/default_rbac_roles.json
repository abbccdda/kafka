// (Copyright) [2019 - 2019] Confluent, Inc.

// Default role definitions with access policies
/*
 RBAC and Acls
 ----
 As a feature, RBAC was built to be able to work in parallel with existing (Kafka) ACLs and their
  notions of ResourceTypes and Operations.
 Other CP components like Connect, KSQL, etc previously didn't have notions of ACLs, resourceTypes,
  and operations, so for those components resourceTypes and operations were net new concepts.

 Kafka ACls are very granular; to be able to "do anything useful" you typically need to be granted
  a number of individual ACLs.

 RBAC roles can thus be thought of a "predefined" sets of ACLs that can be granted together.


 Short Overview of Kafka ACLs
  Acls were added to Kafka in KIP-140, which introduced very "filesystem-ish" flavored Operations :
    All, Read, Write, Create, Delete, Alter, Describe
  For ResourceTypes :
    Any, Topic, Group, Cluster

  KIP-133 added operations AlterConfigs and DescribeConfigs and ResourceType "Broker"

 See http://kafka.apache.org/documentation/#operations_resources_and_protocols for a table
  that lays out Kafka ResourceTypes and Operations and what they mean.

 Some Kafka ACL quirks to be aware of :
  - resourceType:Cluster operation:Create means you can create Topics on a cluster
    - It does not mean you can "create" the cluster (would be hard for the cluster to enforce that)
  - resourceType:Cluster operation:Alter means you can create/edit ACLs
  - the way you grant someone the ability to act on all resources of a given resource type is to
    use a "LITERAL" pattern with a "*" name
    - for example to consume from any topic on a Kafka cluster, grant :
      resourceType:Topic operation:Read patternType:LITERAL name:*


 RBAC Role types / what do "bindingScope" and "bindWithResource" mean?
 ----

 An RBAC role binding has two pieces of information that together identify what the
 binding applies to: the Scope, and the Resources. In Confluent Platform, the Scope
 must always refer to a cluster. This is not true in Confluent Cloud, where the Scope
 may refer to a broader scope like an environment or an organization.

 Several roles are bound using no resources. We can think of these as "Cluster"
 roles. They grant permissions on all resources of a particular type in the cluster.
 All of the "Admin" roles and the "Operator" role fall in this category.
 It is an error to bind these roles and specify a resource,
 and their access policy is marked with `"bindWithResource": false`.

  Example : the ClusterAdmin role has

      "name" : "ClusterAdmin",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource" : false,
        "allowedOperations" : [
          {
            "resourceType" : "Cluster",
            "operations" : [... "AlterConfigs" ...]
          {
            "resourceType" : "Topic",
            "operations" : [... "AlterConfigs" ...]

  So granting Bob ClusterAdmin on a Kafka cluster means Bob can AlterConfigs of both the
   Kafka cluster and all Topics in it.

 Other roles are always bound with specific resources. We can think of these as
 "Resource" roles. They grant permissions on resources specified as literals, prefixes,
 or wildcards. The "ResourceOwner" and "Developer..." roles fall in this category.
 It is an error to bind thse roles without specifying a resource,
 and their access policy is marked with `"bindWithResource": true`.

  Example : granting Bob DeveloperRead for Topic "foo" on a Kafka cluster gets Bob the
   ability to Read and Describe that topic (which would be two ACLs.)

      "name" : "DeveloperRead",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource" : true,
        "allowedOperations" : [
          {
            "resourceType" : "Topic",
            "operations" : ["Read", "Describe"]  // would be two ACLs
          },


 Taxonomy of ResourceTypes
 ----
 CP Component : Kafka
  Cluster - the Kafka cluster
  DelegationToken - legacy Kafka thing not really used
  Topic
  Group - Consumer Groups
  TransactionalId - Producer related

 CP Component : Connect
  Connector
  Secret - Connect's secret registry/store

 CP Component : SchemaRegistry
   Subject

 CP Component : Ksql
  KsqlCluster

 CP Component : C3
  ControlCenterBrokerMetrics

 CP Component : ClusterRegistry
  ClusterRegistry


 RBAC Specific ResourceTypes and Operations
 ----
 Operations : DescribeAccess, AlterAccess are about viewing and altering Rolebindings.
   They are what allow UserAdmins and ResourceOwners to do RoleBinding.

 ResourceType : SecurityMetadata
   Allows UserAdmin to view rollups of other users' rolebinding information.


 All resourceType and All operation
 ----
 These are special case grants that are used to
  - make the SystemAdmin role basically be the RBAC equivalent of Broker super.user
  - allow UserAdmin to grant roles for any/All resourceTypes
  - allow SecurityAdmin to read all Rolebindings across all resourceTypes
*/

{
  "bindingScopes": ["cluster"],
  "roles" : [
    {
      "name" : "SystemAdmin",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": false,
        "allowedOperations" : [
          {
            "resourceType" : "All",
            "operations" : ["All"]
          }
        ]
      }
    },
    {
      "name" : "UserAdmin",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": false,
        "allowedOperations" : [
          {
            "resourceType" : "Cluster",
            "operations" : ["Alter", "Describe"]
          },
          {
            "resourceType" : "DelegationToken",
            "operations" : ["Describe"]
          },
          {
            "resourceType" : "Secret",
            "operations" : ["Create", "Read", "Delete"]
          },
          {
            "resourceType" : "SecurityMetadata",
            "operations" : ["Describe", "Alter"]
          },
          {
            "resourceType" : "All",
            "operations" : ["DescribeAccess", "AlterAccess"]
          }
        ]
      }
    },
    {
      "name" : "ClusterAdmin",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": false,
        "allowedOperations" : [
          {
            "resourceType" : "Cluster",
            "operations" : ["Create", "Alter", "AlterConfigs", "Describe", "DescribeConfigs"]
          },
          {
            "resourceType" : "Topic",
            "operations" : ["Create", "Delete", "Alter", "AlterConfigs", "Describe", "DescribeConfigs"]
          },
          {
            "resourceType" : "Subject",
            "operations" : ["Read", "Write", "Delete", "ReadCompatibility", "WriteCompatibility"]
          },
          {
            "resourceType" : "Connector",
            "operations" : ["Create", "ReadConfig", "ReadStatus", "ReadActiveTopics", "Pause", "Resume", "Scale", "Delete", "ResetActiveTopics"]
          },
          {
            "resourceType" : "Secret",
            "operations" : ["Create", "Read", "Delete"]
          },
          {
            "resourceType" : "KsqlCluster",
            "operations" : ["Contribute", "Terminate"]
          },
          {
            "resourceType" : "ControlCenterBrokerMetrics",
            "operations" : ["Read"]
          },
          {
            "resourceType" : "ControlCenterAlerts",
            "operations" : ["Read", "Write"]
          },
          {
            "resourceType" : "ClusterRegistry",
            "operations" : ["Alter", "Describe"]
          }
        ]
      }
    },
    {
      "name" : "Operator",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": false,
        "allowedOperations" : [
          {
            "resourceType" : "Topic",
            "operations" : ["Describe"]
          },
          {
            "resourceType" : "Connector",
            "operations" : ["ReadStatus", "ReadActiveTopics", "Pause", "Resume", "Scale", "ResetActiveTopics"]
          },
          {
            "resourceType" : "ControlCenterBrokerMetrics",
            "operations" : ["Read"]
          },
          {
            "resourceType" : "ControlCenterAlerts",
            "operations" : ["Read", "Write"]
          },
          {
            "resourceType" : "ClusterRegistry",
            "operations" : ["Describe"]
          }
        ]
      }
    },
    {
      "name" : "SecurityAdmin",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": false,
        "allowedOperations" : [
          {
            "resourceType" : "All",
            "operations" : ["DescribeAccess"]
          }
        ]
      }
    },
    {
      "name" : "AuditAdmin",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": false,
        "allowedOperations" : [
          {
            "resourceType" : "Cluster",
            "operations" : ["DescribeConfigs", "AlterConfigs"]
          }
        ]
      }
    },
    {
      "name" : "ResourceOwner",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": true,
        "allowedOperations" : [
          {
            "resourceType" : "Topic",
            "operations" : ["Create", "Delete", "Read", "Write", "Describe", "DescribeConfigs", "Alter", "AlterConfigs", "DescribeAccess", "AlterAccess", "ControlCenterTriggerWrite"]
          },
          {
            "resourceType" : "Group",
            "operations" : ["Read", "Describe", "Delete", "DescribeAccess", "AlterAccess", "ControlCenterTriggerWrite"]
          },
          {
            "resourceType" : "TransactionalId",
            "operations" : ["Write", "Describe", "DescribeAccess", "AlterAccess"]
          },
          {
            "resourceType" : "Cluster",
            "operations" : ["Create", "IdempotentWrite", "Describe", "DescribeConfigs", "Alter", "AlterConfigs", "DescribeAccess", "AlterAccess"]
          },
          {
            "resourceType" : "Subject",
            "operations" : ["Read", "Write", "Delete", "ReadCompatibility", "WriteCompatibility", "DescribeAccess", "AlterAccess"]
          },
          {
            "resourceType" : "Connector",
            "operations" : ["Create", "ReadConfig", "ReadStatus", "ReadActiveTopics", "Pause", "Resume", "Scale", "Configure", "Delete", "ResetActiveTopics", "DescribeAccess", "AlterAccess"]
          },
          {
            "resourceType" : "KsqlCluster",
            "operations" : ["Contribute", "Terminate", "DescribeAccess", "AlterAccess"]
          }
        ]
      }
    },
    {
      "name" : "DeveloperRead",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": true,
        "allowedOperations" : [
          {
            "resourceType" : "Topic",
            "operations" : ["Read", "Describe"]
          },
          {
            "resourceType" : "Group",
            "operations" : ["Read", "Describe"]
          },
          {
            "resourceType" : "TransactionalId",
            "operations" : ["Describe"]
          },
          {
            "resourceType" : "Cluster",
            "operations" : []
          },
          {
            "resourceType" : "Subject",
            "operations" : ["Read", "ReadCompatibility"]
          },
          {
            "resourceType" : "Connector",
            "operations" : ["ReadConfig", "ReadStatus", "ReadActiveTopics"]
          }
        ]
      }
    },
    {
      "name" : "DeveloperWrite",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": true,
        "allowedOperations" : [
          {
            "resourceType" : "Topic",
            "operations" : ["Write", "Describe"]
          },
          {
            "resourceType" : "Group",
            "operations" : []
          },
          {
            "resourceType" : "TransactionalId",
            "operations" : ["Write", "Describe"]
          },
          {
            "resourceType" : "Cluster",
            "operations" : ["IdempotentWrite"]
          },
          {
            "resourceType" : "Subject",
            "operations" : ["Write", "ReadCompatibility"]
          },
          {
            "resourceType" : "Connector",
            "operations" : ["ReadStatus", "ReadActiveTopics", "Configure", "ResetActiveTopics"]
          },
          {
            "resourceType" : "KsqlCluster",
            "operations" : ["Contribute"]
          }
        ]
      }
    },
    {
      "name" : "DeveloperManage",
      "policy" : {
        "bindingScope" : "cluster",
        "bindWithResource": true,
        "allowedOperations" : [
          {
            "resourceType" : "Topic",
            "operations" : ["Create", "Delete", "Describe", "DescribeConfigs"]
          },
          {
            "resourceType" : "Group",
            "operations" : ["Describe", "Delete"]
          },
          {
            "resourceType" : "TransactionalId",
            "operations" : ["Describe"]
          },
          {
            "resourceType" : "Cluster",
            "operations" : ["Create", "DescribeConfigs"]
          },
          {
            "resourceType" : "Subject",
            "operations" : ["ReadCompatibility", "WriteCompatibility"]
          },
          {
            "resourceType" : "Connector",
            "operations" : ["Create", "ReadStatus", "ReadActiveTopics", "Pause", "Resume", "Scale", "ResetActiveTopics"]
          },
          {
            "resourceType" : "KsqlCluster",
            "operations" : ["Terminate"]
          }
        ]
      }
    }
  ]
}

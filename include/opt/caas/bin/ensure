#!/usr/bin/env bash
#
# Copyright 2016-2017 Confluent Inc.
#

set -o nounset \
    -o errexit \
    -o verbose \
    -o xtrace

echo "===> Check that log dirs are writable ..."
# You need to set KAFKA_LOG_DIRS to be a child of the mount point
# We create the data directory here if necessary to avoid the issue
# where a mounted volume has a lost+found directory
# which makes the broker choke thinking it's a Kafka topic
export KAFKA_LOG_DIRS=$(grep "log.dirs" /opt/caas/config/"${COMPONENT}"/"${COMPONENT}".properties | cut -d '=' -f 2)
mkdir -p "$KAFKA_LOG_DIRS" && chmod -R ag+w "$KAFKA_LOG_DIRS"
dub path "$KAFKA_LOG_DIRS" writable

echo "===> Check that log4j dir is writable ..."
mkdir -p "$KAFKA_LOG4J_DIR" && chmod -R ag+w "$KAFKA_LOG4J_DIR"
dub path "$KAFKA_LOG4J_DIR" writable

echo "===> Check if Zookeeper is healthy ..."
export KAFKA_ZOOKEEPER_CONNECT=$(grep "zookeeper.connect" /opt/caas/config/"${COMPONENT}"/"${COMPONENT}".properties | cut -d '=' -f 2)
cub zk-ready "$KAFKA_ZOOKEEPER_CONNECT" "${KAFKA_CUB_ZK_TIMEOUT:-40}"
